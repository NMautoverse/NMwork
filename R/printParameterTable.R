##' @param pars A parameter table as generated by `NMwork::createParameterTable()`.
##' @param include.fix Either a logical or "ifNotZero".
##' @param include
##' @param drop
##' @param drop.symbol
##' @details A simple printing function for createParameterTable(). It creates three objects.
##' \itemize{
##' \item partab_full: a df with all columns for selected parameters.
##' \item partab_detail: a flextable with selected columns for selected parameters.
##' \item partab_present: a flextable with fewer selected columns for selected parameters.
##' }
##'
##' Notes: I suggest dropping the asterisk on parameter.ltx and
##' instead include a nicely formated transformation column in
##' createParameterTable(). It could be included in a parameter table
##' only if non-standard transformations are used.
##'
##' formatParameterTable is a bad name. This function selects rows and
##' columns in three different levels of detail and returns those
##' three objects. Formatting should happen in
##' `createParameterTable()`.
##'
##' @import data.table
##' @importFrom flextable flextable autofit
##' @export
##'

printParameterTable <- function(pars,format){


    ##paramtbl <- readRDS(file.rds)
    paramtbl <- pars
    
    info.source <- NMinfo(paramtbl)

    if(format=="flextable"){

        library(ftExtra)
        library(dplyr)

        paramtbl <- paramtbl[,.(
            "  "=par.name,
            " "=tab.lab,
            "Estimate (RSE%) [CV% or Corr%]"=tab.est,
            "95% Confidence Interval"=CI,
            panel.label)]

        paramtbl2 <- paramtbl |>
            dplyr::group_by(panel.label) ## |>
        ## slice(1, 2) |>
        ## select(-panel.label)

        ##as_flextable(hide_grouplabel = TRUE)
        ft <- as_flextable(paramtbl2,hide_grouplabel = TRUE) ##|> autofit()

        return(ft)
        
    }



    if(format=="kbl"){

        fixUnder <- function(x)gsub("\\_","\\\\_",x)

        paramtbl2 <- paramtbl[,.(
            "  "=parameter.ltx,
            " "=tab.lab.ltx,
            "Estimate (RSE\\%)\\newline[CV\\% or Corr\\%]"=tab.est.ltx,
            "95\\% Confidence Interval"=CI)]

        
#### configure column justification and sizes. The widths are not automated.
        paramtbl2 <- 
            paramtbl2 |>
            knitr::kable(caption = string.caption,
                         format = "latex",
                         align = paste0("ll",paste(rep("c",times=(ncol(paramtbl2)-2)),collapse = "")),
                         booktabs=T, escape=F) |> 
                                        #col.names = gsub("Description", " ", names(paramtbl))) |>
            kable_styling(full_width = T,font_size = 7.5,  latex_options = "HOLD_position") |>
            column_spec(1, width="4em")|>
            column_spec(2, width = "26em") |>
            column_spec(3, width = "12em")


        nmbrows <- paramtbl[,.N,keyby=.(parGRP)]
        nmbrows[,start:=cumsum(shift(N,1,fill=0))+1]
        nmbrows[,end:=cumsum(N)]
        ## merge onto dt.panel
        dt.panel <- mergeCheck(nmbrows,dt.panel,by.x="parGRP",by.y="panel",all.x=TRUE,quiet=TRUE)

        for(I in 1:nrow(dt.panel)){
            paramtbl2 <- 
                dt.panel[I,pack_rows(paramtbl2,panel.label, start, end)]
        }

### Footnotes
        footnotes <- c("Rationale behind fixed values provided in Section \\ref{sec:BaseModelResults}.",
                       "* parameter was estimated in the log domain and back-transformed for clarity.",
                       "RSE: Relative Standard Error on the scale where the parameter was estimated.")

        if(!is.null(info.source$dataCreate$DataCreateScript)){
            footnotes <- c(footnotes,sprintf("Source: %s",fixUnder(info.source$dataCreate$DataCreateScript)))
        }
        if(!is.null(info.source$dataCreate$model)){
            footnotes <- c(footnotes,sprintf("Model: %s",fixUnder(info.source$dataCreate$model)))
        }


        paramtbl2 <- paramtbl2 |>
            add_footnote(label=footnotes,notation="none",escape=FALSE)

        paramtbl2
    }

}
