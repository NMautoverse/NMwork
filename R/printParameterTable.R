##' Print parameter table to console, flextable, latex, or (latex) pdf file
##' @param pars A parameter table as generated by
##'     `NMwork::createParameterTable()`.
##' @param include.fix Either a logical or "NotZero". `TRUE` means fixed
##'     parameters are not filtered out, `FALSE` means they are filtered out,
##'     "NotZero" means they are only kept if not equal to zero.
##' @param include A character vector of symbol values to include. All else will
##'     be dropped.
##' @param include.pattern A regular expression run on the `symbol` column. What
##'     matches will be kept.
##' @param drop A character vector of symbol values to drop. All else will be
##'     kept.
##' @param drop.pattern A regular expression run on the `symbol` column. What
##'     matches will be dropped.
##' @details kable: for rmd and rmd-latex: can't get longtable to work with
##'     footnotes. Currently not using footnotes.
##'
##' pmtables is only available if the package called pmtables is
##' installed. pmtables is not available on CRAN, at the time of writing
##' this. It can be installed from MPN.
##' @examples
##' file.mod <- system.file("nonmem/xgxr134.mod",package="NMwork")
##' pars <- createParameterTable(file.lst=file.mod,
##'                   args.ParsText=list(format="%idx; %symbol ; %label [%unit] ; %trans",
##'                                      format.sigma="%symbol - %label "))
##' printParameterTable(pars=pars,format="R")
##' printParameterTable(pars=pars,format="rmd")
##' @import data.table
##' @import flextable
##' @import ftExtra
##' @import kableExtra
##' @importFrom fs file_show
##' @importFrom dplyr group_by
##' @export



### TODO This selection can be done once independently of engine. Column names can be translated using latexify as needed.

## TODO make selection dependent on boot/cov

## TODO column names dependent on rse.cov

## TODO sorting should be handled independently of engine

printParameterTable <- function(pars,engine="kable",format,footnotes=NULL,script=NULL,file.mod,include,include.pattern,drop,drop.pattern,include.fix,caption,ci.boot,ci="cov",rse.cov=TRUE,label.pmtables) {

    if(missing(drop)) drop <- NULL
    if(missing(drop.pattern)) drop.pattern <- NULL
    if(missing(include)) include <- NULL
    if(missing(include.fix)) include.fix <- TRUE
    if(missing(include.pattern)) include.pattern <- NULL
    
    ##paramtbl <- readRDS(file.rds)
    paramtbl <- copy(pars)
    info.source <- NMinfo(paramtbl)
    model <- NULL

### only one format at a time supported
    
    if(missing(format)) format <- NULL

    if(length(engine)>1) stop("Only one engine can be used at a time")
    engine <- tolower(NMdata:::cleanSpaces(engine))
    if (!engine %in% c("kable", "pmtables", "flextable"))
        stop("engine must be either kable, flextable, or pmtables.")

    if(is.null(format)){
        format <- switch(engine,
                         pmtables="latex",
                         kable="r",
                         flextable="ft")
    }

    ## avoid pmtables requirement for function/packge    
    if(engine=="pmtables") {
        loadres <- requireNamespace("pmtables",quietly=TRUE)
        if(!loadres) {
            message("pmtables not found. Please install pmtables from MPN to use engine=\"pmtables\". Switching to engine=\"kable\".")
            engine <- "kable"
        }
    }


    compile.pdf <- FALSE
    file.pdf <- NULL
    file.tex <- NULL
    preview.pdf <- FALSE

    if(tolower(NMdata:::cleanSpaces(format))%in%c("tex","latex")) {
### this is currently not supported for kable 
        format <- "latex"
        compile.pdf <- FALSE
    }
### this must happen before any modification of format to not edit a file name    
    if(tolower(fnExtension(format)=="tex") ) {
        file.tex <- format
        format <- "latex"
        compile.pdf <- FALSE
    }
    
    if(tolower(NMdata:::cleanSpaces(format)=="pdf") ) {
        file.pdf <- tempfile(fileext=".pdf")
        format <- "latex"
        compile.pdf <- TRUE
        preview.pdf <- TRUE
    }
    
### this must happen before any modification of format to not edit a file name    
    if(tolower(fnExtension(format)=="pdf") ){
        file.pdf <- format
        format <- "latex"
        compile.pdf <- TRUE
    }


    format <- tolower(format)
    format <- NMdata:::cleanSpaces(format)

    if(length(format)>1) stop("Only one format can be specified.")
                                        # if(!format %in% c("r","html","flextable","latex","rmd-pdf","pdf","kable-rmd","kable-rmd-pdf")) {
                                        #     stop("format must be one of R, flextable, rmd, or a path to a file with extension .pdf.")
                                        # }

    fixUnder <- ifelse(format%in%c("latex"),
                       function(x)gsub("\\_","\\\\_",x),
                       identity)

    if( !missing(file.mod) && !is.null(file.mod) ){
        model <- modelPaths(file.mod)
    } else if(!is.null(info.source$dataCreate$model)){
        
        model <- modelPaths(info.source$dataCreate$model)
    }

### this is a header
    string.caption <- paste0("Model: ",fixUnder(model$run),".")
    if(!missing(caption)){
        string.caption <- paste(paste(caption,collapse=" ")
                               ,string.caption,
                                sep=". "
                                )
    }


##### subset parameters
    if("symbol" %in% colnames(paramtbl)){
        if( !is.null(drop) ){
            paramtbl <- paramtbl[!symbol%in%drop]
        }
        if( !is.null(include) ){
            paramtbl <- paramtbl[symbol%in%include]
        }

        if(!is.null(drop.pattern)){
            paramtbl <- paramtbl[!grepl(pattern=drop.pattern,symbol,fix=FALSE)]
        }

        if(!is.null(include.pattern)){
            paramtbl <- paramtbl[!grepl(pattern=drop.pattern,symbol,fix=FALSE)]
        }
        
        if( is.logical(include.fix) && isFALSE(include.fix) ){
            paramtbl <- paramtbl[FIX==0|symbol%in%include]
        }
        
        if( !is.logical(include.fix) && tolower(include.fix)%in%c("ifnotzero", "notzero") ){
            paramtbl <- paramtbl[FIX==0|est!=0|symbol%in%include]
        }
    }

    
    chars.fnotes <-
        sapply(1:10,function(x)paste(rep(x="*",x),collapse=""))
    paramtbl[par.type=="THETA"&trans%in%c("log","logit"),trans.fnchar:=chars.fnotes[.GRP],by=trans]
    ## paramtbl[par.type=="THETA"&trans%in%c("log"),parameter.ltx:=sub("\\$ *$","\\{\\}\\^\\*\\$",parameter.ltx)]
                                        # paramtbl[par.type=="THETA"&trans%in%c("log"),parameter.ltx:=sub("\\$ *$","\\{\\}\\^\\*\\$",parameter.ltx)]
    paramtbl[,row:=.I]
    paramtbl[par.type=="THETA"&trans%in%c("log","logit"),
             parameter.ltx:=sub("\\$ *$",paste0("\\{\\}\\^\\{",trans.fnchar,"\\}\\$"),parameter.ltx),by=row]
    paramtbl[par.type=="THETA"&trans%in%c("log","logit"),
             parameter:=paste0(parameter,trans.fnchar)]
    paramtbl[par.type=="THETA"&trans%in%c("log","logit"),
             par.name:=paste0(par.name,trans.fnchar)]
    

    footnotes.trans <- unique(paramtbl[!is.na(trans.fnchar)],by="trans")[,
                                                                         sprintf("%s Parameter was estimated in the %s domain. Estimate and CI presented on physiological scale.",trans.fnchar,trans)]
    
    footnotes <- c(footnotes,
                   footnotes.trans,
                   "CI: Confidence Interval based on Nonmem Covariance step.",
                   "CV: Coefficient of Variation for log-normal distributed random effects.",
                   "Corr: Correlation.",
                   "RSE: Relative Standard Error on the scale where the parameter was estimated.")
    if(!is.null(script)){
        footnotes <- c(footnotes,sprintf("Source: %s",fixUnder(script)))
    }
    if(!is.null(model)){
        footnotes <- c(footnotes,sprintf("Model: %s",fixUnder(model$label)))
    }

### add columns for reporting
    paramtbl <- addEstFormat(pars=paramtbl,rse.cov=rse.cov)
    paramtbl[,CI:=switch(ci,
                         cov=tab.CI,
                         boot=tab.CI.boot,
                         none="")]

    ## sorting must be done on paramtbl from which nmbrows is generated.
    setorder(paramtbl,panel,i,j)

    if(engine=="kable"&&format=="r"){
        paramtbl2 <- paramtbl[,.(
            "Parameter"=par.name,
            "Label"=tab.lab,
            "Est [CV% or Corr%] (RSE%)"=tab.est,
            "95% CI"=CI,
            Panel=panel
        )]

    } else {

### would be better to have one column selection and namoing for kable and
### pmtables. So far paramtbl1 is for pmtables, paramtbl2 is for kable.
        
        paramtbl1 <- paramtbl[,.(
            parameter.ltx,
            tab.lab.ltx,
            tab.est.ltx,
            CI,
            panel.label)]
        
        paramtbl2 <- paramtbl[,.(
            "  "=if(format=="latex") parameter.ltx else par.name,
            " "=if(format=="latex") tab.lab.ltx else tab.lab ,
            "Estimate (RSE%)\\newline[CV% or Corr%]"=
                if(format=="latex") tab.est.ltx else tab.est ,
            "95% Confidence Interval"=CI,
            panel.label)]

        if(format=="latex"){
            ## colnames(paramtbl2) <- latexify(colnames(paramtbl2))
            cnames <- copy(colnames(paramtbl2))
            cnames[grepl("^ *$",cnames)] <- latexify(cnames[grepl("^ *$",cnames)])
            colnames(paramtbl2) <- cnames
        }
    }
    

    if(engine=="kable"){
### not sure what formats are supported. At least latex, and html.

        if(format=="r"){
                                        # paramtbl2 <- paramtbl[,.(
                                        #     "Parameter"=par.name,
                                        #     "Label"=tab.lab,
                                        #     "Est [CV% or Corr%] (RSE%)"=tab.est,
                                        #     "95% CI"=CI,
                                        #     Panel=panel
                                        # )]
            
            silent <- lapply(footnotes,message)
            return(
                kable(paramtbl2,format="pipe")
            )
        }

        ##
        nmbrows <- paramtbl2[,.N,keyby=.(panel.label)]
        nmbrows[,start:=cumsum(shift(N,1,fill=0))+1]
        nmbrows[,end:=cumsum(N)]
        paramtbl2 <- select(paramtbl2,-panel.label)

        
#### configure column justification and sizes. The widths are not automated.
        paramtbl2 <-
            paramtbl2 |>
            knitr::kable(
                       ## format = "latex",
                       format = format,
                       align = paste0("ll",paste(rep("c",times=(ncol(paramtbl2)-2)),collapse = "")),
                       caption = string.caption,
                       ## longtable=T,
                       booktabs=T, escape=F) |>
                                        #col.names = gsub("Description", " ", names(paramtbl))) |>
            kable_styling(full_width = T,
                          font_size = 7.5,  latex_options = "HOLD_position") |>
            column_spec(1, width="4em")|>
            column_spec(2, width = "26em") |>
            column_spec(3, width = "12em")

        
        ## for(I in 1:nrow(dt.panel)){
        for(I in 1:nrow(nmbrows)){
            paramtbl2 <- 
                nmbrows[I,pack_rows(paramtbl2,panel.label, start, end)]
        }

### Footnotes
        pars.ltx <- paramtbl2 |>
            add_footnote(label=footnotes,notation="none",escape=FALSE)

        if(!compile.pdf) {
            if(is.null(file.tex)){
                return(pars.ltx)
            } else {
                NMsim:::writeTextFile(pars.ltx,file=file.tex)
                return(invisible(file.tex))
            }


        }

        if(compile.pdf){
                                        # if(is.null(file.pdf)) file.pdf <- tempfile(fileext=".pdf")
            ## "\\usepackage[margin=1in]{geometry}",
            latexStandAlone(pars.ltx,file.pdf=file.pdf,
                            usepackage=cc("geometry:margin=1in",
                                          booktabs,float,tabu,longtable
                                          ))
            if(preview.pdf) file_show(file.pdf)
            ## return path to output?
            return(file.pdf)
        }
    }

    if(engine=="flextable"){

        paramtbl2 <- paramtbl2 |>
            dplyr::group_by(panel.label) ## |>
        ## slice(1, 2) |>
        ## select(-panel.label)
        
        ##as_flextable(hide_grouplabel = TRUE)
        ft <- as_flextable(paramtbl2,hide_grouplabel = TRUE) 
        ft <- theme_vanilla(ft)
        ft <- add_footer_lines(ft, footnotes)
        ft <- color(ft, part = "footer", color = "#666666")
        ft <- fontsize(ft, part = "footer", size=10)
        ft <- align(ft, part="footer", align = "left")
        ft <- line_spacing(ft, space = 1, part = "footer")
        ft <- autofit(ft)

        ## if(format=="docx"){
        ##     save_as_docx(path=file.out)
        ## }
        

        ## flextable::save_as_pptx
        ## flextable::save_as_html
        ## flextable::save_as_image
        
        
        return(ft)
        
    }


    if(engine=="pmtables"){
        ## formats: latex, pdf, latex-pdf?

        loadres <- requireNamespace("pmtables",quietly=TRUE)
        if(!loadres) {
            stop("to use the pmtables format, pmtables must be installed. Find it on MPN.")
        }

        
                                        # paramtbl2 <-
                                        #     paramtbl |>
                                        #     dplyr::select(par.type, panel.label, i, j, parameter.ltx, tab.lab.ltx, tab.est.ltx, CI) |>
                                        #     dplyr::arrange(panel.label, i, j) |>
                                        #     dplyr::transmute(panel.label, parameter.ltx, tab.lab.ltx, tab.est.ltx, CI) |>
                                        #     dplyr::mutate(rows.group = 1:dplyr::n(),.by=tab.lab.ltx) |>
                                        #     dplyr::filter(rows.group==1) |>
                                        #     dplyr::select(-rows.group)
        
        ## pars.ltx = 
        ##     paramtbl2 |>
        ##     pmtables::st_new() |>
        ##     pmtables::st_panel("panel.label") |>
        ##     ## tab.lab.ltx is " "
        ##     pmtables::st_center(" "= pmtables::col_ragged(6.5)) 
                                        # pmtables::st_blank("parameter.ltx","tab.lab.ltx") |>
                                        # pmtables::st_rename("Estimate (RSE\\%)...[CV\\% or Corr\\%]" = "tab.est.ltx",
                                        #                     "95\\% Confidence Interval" = "CI") 
        ##setnames(old=c("tab.est.ltx","CI"),c("Estimate (RSE\\%)...[CV\\% or Corr\\%]","95\\% Confidence Interval"))

        pars.ltx = 
            paramtbl1 |>
            pmtables::st_new() |>
            pmtables::st_panel("panel.label") |>
            ## tab.lab.ltx is " "
            pmtables::st_center("tab.lab.ltx"= pmtables::col_ragged(6.5)) |>
            ## pmtables::cols_align(.r="tab.est.ltx,CI") |> 
            pmtables::st_blank("parameter.ltx","tab.lab.ltx") |>
            pmtables::st_rename("Estimate (RSE\\%)...[CV\\% or Corr\\%]" = "tab.est.ltx",
                                "95\\% Confidence Interval" = "CI") 
        
        if(!is.null(footnotes)){
            for(fn in footnotes) pars.ltx <- pmtables::st_notes(pars.ltx,fn)
        }
        ## st_notes("$^*$Parameter was estimated in the log-domain and back-transformed for clarity") |>
        ##             st_notes("Abbreviations: RSE = relative standard error (on the scale where the parameter was estimated)") |>
        ##             st_notes(paste0("Model: ", model$mod)) |>
        pars.ltx <- pars.ltx |> pmtables::st_noteconf(type = "minipage", width = 1) 

        pars.ltx <- 
            pars.ltx |>
            pmtables::stable_long(lt_cap_text=string.caption,lt_cap_label = label.pmtables)
        
        if( format=="latex" && !compile.pdf ) {
            ## create latex code. Don't compile.

            if(is.null(file.tex)){
                res <- pars.ltx # |>
                                        # paste(collapse="\n") |>
                                        # cat()
            } else {
                res <- pars.ltx |>
                    paste(collapse="\n") |>
                    NMsim:::writeTextFile(file=file.tex)
            }

            return(invisible(res))
        }

### with own setting of temp file.pdf, this should never happen
        if( format=="latex" && compile.pdf && is.null(file.pdf) ){
            warning("with internal setting of temp file.pdf, this should never happen")
            
            ## Creating pdf in tmp location. 
            pars.ltx |>
                pmtables::st2report()
            ## what to return in this case?
            return(invisible(NULL))
        }

        if( format=="latex" && compile.pdf && !is.null(file.pdf) ){
            ## Creating pdf in named location. 
            ## This used to be format=="rmd-pdf"
            
            ## What is being returned?
            res <-
                pmtables::st2pdf(x=pars.ltx,dir = dirname(file.pdf), stem = fnExtension(basename(file.pdf), ""))
            if(preview.pdf) file_show(file.pdf)
            return(res)
        }

    }
}

