##' @param pars A parameter table as generated by `NMwork::createParameterTable()`.
##' @param include.fix Either a logical or "ifNotZero".
##' @param include
##' @param drop
##' @param drop.symbol
##'
##' @import data.table
##' @import flextable
##' @import ftExtra
##' @import kable
##' @import kableExtra
##' @importFrom dplyr group_by
##' @export
##'

## todo

## tolowor(format)

## get.arg format

## switch

## if rmd, latexify footnotes? How about underscores - fixUnder too? Yes, do both fixes in rmd case.

### for rmd and rmd-latex: can't get longtable to work with
### footnotes. Currently not using footnotes.

printParameterTable <- function(pars,format,footnotes=NULL,script=NULL,file.mod){
    
    fixUnder <- function(x)gsub("\\_","\\\\_",x)
    
    ##paramtbl <- readRDS(file.rds)
    paramtbl <- pars
    info.source <- NMinfo(paramtbl)
    model <- NULL

### only one format at a time supported
    
    if(tolower(fnExtension(format))=="pdf"){
        file.pdf <- format
        format <- "rmd-pdf"
    }

    fixUnder <- ifelse(format%in%c("rmd","rmd-pdf"),
                       function(x)gsub("\\_","\\\\_",x),
                       identity)
    
    if( !missing(file.mod) && !is.null(file.mod) ){
        model <- modelPaths(file.mod)
    } else if(!is.null(info.source$dataCreate$model)){
        model <- modelPaths(info.source$dataCreate$model)
    }
    
### this is a header
    string.caption <- paste0("Base model parameters"
                            ," (Model ",fixUnder(model$run),")"
                             )


    footnotes <- c(footnotes,
                   "* parameter was estimated in the log domain and back-transformed for clarity.",
                   "RSE: Relative Standard Error on the scale where the parameter was estimated.")

    if(!is.null(script)){
        footnotes <- c(footnotes,sprintf("Source: %s",fixUnder(script)))
    }
    if(!is.null(model)){
        footnotes <- c(footnotes,sprintf("Model: %s",fixUnder(model$label)))
    }


    if(format=="R"){

        paramtbl <- paramtbl[,.(
            Panel=panel.label,
            "Parameter"=par.name,
            "Label"=tab.lab,
            "Estimate (RSE%) [CV% or Corr%]"=tab.est,
            "95% Confidence Interval"=CI
            )]

lapply(footnotes,message)
        return(kable(paramtbl,format="pipe"))
    }


    

    if(format=="flextable"){

        paramtbl <- paramtbl[,.(
            "  "=par.name,
            " "=tab.lab,
            "Estimate (RSE%) [CV% or Corr%]"=tab.est,
            "95% Confidence Interval"=CI,
            panel.label)]

        paramtbl2 <- paramtbl |>
            dplyr::group_by(panel.label) ## |>
        ## slice(1, 2) |>
        ## select(-panel.label)

        ##as_flextable(hide_grouplabel = TRUE)
        ft <- as_flextable(paramtbl2,hide_grouplabel = TRUE) ##|> autofit()

        ft <- theme_vanilla(ft)
        ft <- add_footer_lines(ft, footnotes)
        ft <- color(ft, part = "footer", color = "#666666")
        ft <- fontsize(ft, part = "footer", size=10)
        ft <- align(ft, part="footer", align = "left")
        ft <- line_spacing(ft, space = 1, part = "footer")
        
        return(ft)
        
    }



    if(format%in%c("rmd","rmd-pdf")){
        ## fixUnder <- function(x)gsub("\\_","\\\\_",x)

        nmbrows <- paramtbl[,.N,keyby=.(panel.label)]
        nmbrows[,start:=cumsum(shift(N,1,fill=0))+1]
        nmbrows[,end:=cumsum(N)]
        ## merge onto dt.panel
        ##dt.panel <- mergeCheck(nmbrows,dt.panel,by.x="parGRP",by.y="panel",all.x=TRUE,quiet=TRUE)


        paramtbl2 <- paramtbl[,.(
            "  "=parameter.ltx,
            " "=tab.lab.ltx,
            "Estimate (RSE\\%)\\newline[CV\\% or Corr\\%]"=tab.est.ltx,
            "95\\% Confidence Interval"=CI)]

        
#### configure column justification and sizes. The widths are not automated.
        paramtbl2 <- 
            paramtbl2 |>
            knitr::kable(
                       format = "latex",
                       align = paste0("ll",paste(rep("c",times=(ncol(paramtbl2)-2)),collapse = "")),
                       caption = string.caption,
                       ## longtable=T,
                       booktabs=T, escape=F) |> 
                                        #col.names = gsub("Description", " ", names(paramtbl))) |>
            kable_styling(full_width = T,
               font_size = 7.5,  latex_options = "HOLD_position") |>
            column_spec(1, width="4em")|>
            column_spec(2, width = "26em") |>
            column_spec(3, width = "12em")

        
        ## for(I in 1:nrow(dt.panel)){
        for(I in 1:nrow(nmbrows)){
            paramtbl2 <- 
                nmbrows[I,pack_rows(paramtbl2,panel.label, start, end)]
        }

        

### Footnotes

        
        pars.ltx <- paramtbl2 |>
            add_footnote(label=footnotes,notation="none",escape=FALSE)


        if(format=="rmd") return(pars.ltx)
        
    }

    if(format=="rmd-pdf"){
        ## "\\usepackage[margin=1in]{geometry}",
        latexStandAlone(pars.ltx,file.pdf=file.pdf,
                        usepackage=cc("geometry:margin=1in",
                                      booktabs,float,tabu,longtable
                                      ))
        ## return path to output?
    }

}
